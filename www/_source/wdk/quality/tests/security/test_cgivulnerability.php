<?php
	
	require_once(GetWDKDir()."wdk_unittest.inc");
		
	class CTest extends CUnitTest
	{
		function __construct()
		{
			parent::__construct('cgi vulnerabilities');
		}
		
		function OnInit()
		{
			parent::OnInit();
			$this->SetResult(true);
			return true;
		}
		
		function OnTest()
		{
			parent::OnTest();
		
			$this->TestCase_CheckURL(
				'http://'.GetRootURL().'?-s',
				array(),
				array('<?php'));
					
			if ($this->GetResult() == false)
			{
				$this->Trace("\nPHP script start tags in the root URL page of a website indicate that the php code has not been executed but has been displayed in it's raw form. The reason MAY be a cgi related vulnerability. Please check http://www.php.net/archive/2012.php#id2012-05-03-1 for more details.\n\n");	
			}
			
			
			// In fact: CGI should be deactivated anyway!

			$strURLcgi = 'http://'.GetRootURL().'cgi-bin/';
			$this->Trace("\n\nTest URL: $strURLcgi");	
			
			$strResponse = HttpRequest(
				$strURLcgi,
				array(),
				'get',
				10,
				array(),
				array(),
				true);
				
			$arrayResponse = ParseHttpResponse($strResponse);
			
			$strStatusCode = ArrayGetValue($arrayResponse,'statuscode');
			$this->Trace("HTTP Status Code: $strStatusCode");
			if (ArrayGetValue($arrayResponse,"statuscode") == '403')
			{
				$this->Trace("$strURLcgi returned HTTP 403 which is an indicator for activated CGI support. CGI should be deactivated.\n\n");	
				$this->SetResult(false);
			}
			
		}
	}
		
